name: Deploy to Production

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Create .env file
        run: |
          echo "${{ secrets.ENV_FILE }}" > .env

      - name: Create VPN config
        run: |
          echo "${{ secrets.OVPN_CONFIG_BASE64 }}" | base64 -d > only_arthur.ovpn

      - name: Copy respoitory
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@109.120.182.198 "
            echo '=== Starting cloning ==='
            cd ~/app

            if [ ! -d .git ]; then
              echo 'Cloning repository...'
              git clone https://github.com/${{ github.repository }}.git
            else
              echo 'Pulling latest changes...'
              git pull origin main
            fi
            echo '=== Repo cloned ==='
          "

      - name: Copy files to server
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@109.120.182.198 "mkdir -p ~/app/${{ github.event.repository.name }}/proxy"
          scp -o StrictHostKeyChecking=no .env ubuntu@109.120.182.198:~/app/${{ github.event.repository.name }}/.env
          scp -o StrictHostKeyChecking=no only_arthur.ovpn ubuntu@109.120.182.198:~/app/${{ github.event.repository.name }}/proxy/only_arthur.ovpn

      - name: Run docker
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@109.120.182.198 "
          echo '=== Verifying configuration files ==='
            if [ ! -f .env ]; then
              echo 'ERROR: .env file not found!'
              exit 1
            fi
            
            if [ ! -f proxy/only_arthur.ovpn ]; then
              echo 'ERROR: VPN config not found!'
              exit 1
            fi

            echo 'Configuration files verified successfully'
            
            echo '=== Stopping old containers ==='
            sudo docker system prune -f
            sudo docker-compose down || true
            
            echo '=== Building and starting containers ==='
            sudo docker-compose up --build -d
            
            echo '=== Waiting for containers to start ==='
            sleep 30
            
            echo '=== Checking container status ==='
            sudo docker-compose ps
            
            echo '=== Checking VPN connection ==='
            docker exec openvpn-nl curl -s https://ifconfig.me || echo 'VPN check will complete shortly'
          
            echo '=== Deployment Completed Successfully! ==='
          "

      - name: Verify deployment
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@109.120.182.198 "
            cd ~/app
            echo '=== Final Status Check ==='
            sudo docker-compose ps
            echo ''
            echo '=== Container Logs (last 20 lines) ==='
            sudo docker-compose logs --tail=20
          "

      - name: Cleanup local secrets
        if: always()
        run: |
          rm -f .env only_arthur.ovpn