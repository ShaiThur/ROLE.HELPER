version: "3.8"

services:
  xray-vpn:
    restart: always
    image: teddysun/xray:latest
    container_name: xray-vpn-nl
    cap_add:
      - NET_ADMIN
    environment:
      - TZ=Europe/Amsterdam
    volumes:
      - ./proxy/config.json:/etc/xray/config.json:ro
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    healthcheck:
      test: [ "CMD", "sh", "-c", "wget -q --spider --timeout=10 --proxy=http://127.0.0.1:10808 https://ifconfig.me || exit 1" ]
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 30s
    ports:
      - "10808:10808"
      - "1080:1080"
      - "8081:8080"
    networks:
      - vpn_network

  vpn-checker:
    image: curlimages/curl:latest
    container_name: vpn-check
    network_mode: "service:xray-vpn"
    depends_on:
      xray-vpn:
        condition: service_healthy
    command: >
      sh -c "
      while true; do
        echo '=== VPN Status Check ===';
        echo 'External IP:';
        curl -x http://127.0.0.1:10808 -s https://ifconfig.me;
        echo '';
        echo 'Location:';
        curl -x http://127.0.0.1:10808 -s https://ipapi.co/json | grep -E 'country_name|city';
        echo '';
        echo 'Testing connection...';
        curl -x http://127.0.0.1:10808 -s -o /dev/null -w 'HTTP Status: %{http_code}\n' https://twitter.com || echo 'Connection check failed';
        echo '========================';
        sleep 300;
      done
      "
    restart: unless-stopped

  python-app:
    volumes:
      - ./images:/images
    restart: always
    container_name: role-helper
    image: role-helper:1.0
    network_mode: "service:xray-vpn"
    depends_on:
      xray-vpn:
        condition: service_healthy
      db:
        condition: service_started
    logging:
      driver: "json-file"
      options:
        max-file: "5"
        max-size: "10m"
    build:
      context: "."
      dockerfile: ./Dockerfile
    env_file:
      - .env
    environment:
      - DB_HOST=db
      - HTTP_PROXY=http://127.0.0.1:10808
      - HTTPS_PROXY=http://127.0.0.1:10808
    command: [ "python", "main.py" ]

  db:
    restart: always
    container_name: postgres-db
    image: ankane/pgvector
    environment:
      - POSTGRES_DB=vectordb
      - POSTGRES_USER=role-helper-history
      - POSTGRES_PASSWORD=role-helper-history
      - POSTGRES_HOST_AUTH_METHOD=trust
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - vpn_network
    ports:
      - "5555:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U role-helper-history -d vectordb"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
    driver: local

networks:
  vpn_network:
    driver: bridge